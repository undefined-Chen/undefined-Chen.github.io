{{ $dbUrl := .Get 0 }}
{{ $customComment := .Get 1 }}
{{ $apiUrl := "https://neodb.social/api/me/shelf/item/" }}
{{ $itemUuid := "" }}
{{ $authToken := "Nil_zJ2Vd7YJvzRZZk3MJr_TFZK_TlODqoz8SxBAI7Jt7D3QaRO83HRbOA" }} <!-- Replace with your actual API token -->

{{/* 获取当前页面语言，优先 Site.Language.Lang，其次 Page.Language.Lang，默认为 zh-cn */}}
{{ $lang := "" }}
{{ if .Site.Language.Lang }}
  {{ $lang = .Site.Language.Lang }}
{{ else if .Page.Language.Lang }}
  {{ $lang = .Page.Language.Lang }}
{{ else }}
  {{ $lang = "zh-cn" }}
{{ end }}

{{/* 定义中英文变量 */}}
{{ $actionBook := cond (eq $lang "en") "read" "读" }}
{{ $actionTv := cond (eq $lang "en") "watch" "看" }}
{{ $actionMovie := cond (eq $lang "en") "watch" "看" }}
{{ $actionPodcast := cond (eq $lang "en") "listen" "听" }}
{{ $actionAlbum := cond (eq $lang "en") "listen" "听" }}
{{ $actionGame := cond (eq $lang "en") "play" "玩" }}

{{ $prefixWishlist := cond (eq $lang "en") "Want to " "想" }}
{{ $prefixComplete := cond (eq $lang "en") "" "" }}
{{ $prefixProgress := cond (eq $lang "en") "Currently " "在" }}
{{ $prefixDropped := cond (eq $lang "en") "Stopped " "不" }}

{{ $suffixComplete := cond (eq $lang "en") "ed" "过" }}
{{ $suffixDropped := cond (eq $lang "en") "" "了" }}

{{ $dateFormat := cond (eq $lang "en") "Jan 02, 2006" "2006 年 01 月 02 日" }}

<!-- Extract item_uuid from the URL -->
{{ if (findRE `.*neodb\.social\/.*\/(.*)` $dbUrl) }} {{ $itemUuid = replaceRE
`.*neodb\.social\/.*\/(.*)` "$1" $dbUrl }} {{ else }}
<p style="text-align: center"><small>Invalid URL format.</small></p>
{{ return }} {{ end }}

<!-- Construct the API URL -->
{{ $dbApiUrl := print $apiUrl $itemUuid }}

<!-- Set up the Authorization header -->
{{ $opts := dict "headers" (dict "Authorization" (print "Bearer " $authToken))
}}

<!-- Fetch JSON from the API using resources.GetRemote -->
{{ $dbFetch := resources.GetRemote $dbApiUrl $opts | transform.Unmarshal }}

<!-- Determine shelf status -->
{{ $shelfType := $dbFetch.shelf_type }}
{{ $category := $dbFetch.item.category }}
{{ $action := "" }}
{{ $prefix := "" }}
{{ $suffix := "" }}
{{ $displayText := "" }}

<!-- 动作选择 -->
{{ if eq $category "book" }}
  {{ $action = $actionBook }}
{{ else if or (eq $category "tv") (eq $category "movie") }}
  {{ $action = $actionTv }}
{{ else if or (eq $category "podcast") (eq $category "album") }}
  {{ $action = $actionPodcast }}
{{ else if eq $category "game" }}
  {{ $action = $actionGame }}
{{ end }}

<!-- 前缀/后缀选择 -->
{{ if eq $shelfType "wishlist" }}
  {{ $prefix = $prefixWishlist }}
  {{ $suffix = "" }}
{{ else if eq $shelfType "complete" }}
  {{ $prefix = $prefixComplete }}
  {{ $suffix = $suffixComplete }}
{{ else if eq $shelfType "progress" }}
  {{ $prefix = $prefixProgress }}
  {{ $suffix = "" }}
{{ else if eq $shelfType "dropped" }}
  {{ $prefix = $prefixDropped }}
  {{ $suffix = $suffixDropped }}
{{ end }}

{{ $displayText = print $prefix $action $suffix }}

<!-- Prep for star rating -->
{{ $fullStars := 0 }} {{ $starCount := 0 }} {{ $halfStar := 0 }} {{ $emptyStars
:= 5 }}
<!-- Calc star rating -->
{{ $rating := $dbFetch.rating_grade }}
<!-- Get the rating -->
{{ if $rating }} {{ $starCount = div (mul $rating 5) 10 }} {{ $fullStars = int
$starCount }}
<!-- Full stars count -->

<!-- Determine if there is a half star -->
{{ if (mod $rating 2) }} {{ $halfStar = 1 }} {{ end }}

<!-- Calculate empty stars -->
{{ $emptyStars = sub 5 (add $fullStars $halfStar) }}
<!-- Empty stars count -->
{{ end }}

<!-- Check if data is retrieved -->
{{ if $dbFetch }}
<div class="db-card">
  <div class="db-card-subject">
    <div class="db-card-post">
      <img
        src="{{ $dbFetch.item.cover_image_url }}"
        alt="Cover Image"
        style="max-width: 100%; height: auto"
      />
    </div>
    <div class="db-card-content">
      <div class="db-card-title">
        <a href="{{ $dbUrl }}" class="cute" target="_blank" rel="noreferrer"
          >{{ $dbFetch.item.title }}</a
        >
      </div>
      <div class="db-card-rating">
        {{ $dbFetch.created_time | time.Format "2006-01-02T15:04:05Z" | time.Format $dateFormat }} {{ $displayText }}
        <!-- Add the rating as stars -->
        <div class="db-card-rating-stars">
          <!-- Full stars -->
          {{ if $fullStars }} {{ range $i := (seq 1 $fullStars) }}
          <i class="fa-solid fa-star"></i>
          {{ end }} {{ end }}

          <!-- Half star -->
          {{ if $halfStar }}
          <i class="fa-regular fa-star-half-stroke"></i>
          {{ end }}

          <!-- Empty stars -->
          {{ if $emptyStars }} {{ range $i := (seq 1 $emptyStars) }}
          <i class="fa-regular fa-star"></i>
          {{ end }} {{ end }}
        </div>
      </div>
      <div class="db-card-comment">
        {{ if $customComment }}
          {{ $customComment | markdownify }}
        {{ else }}
          {{ $dbFetch.comment_text | markdownify }}
        {{ end }}
      </div>
    </div>
    <div class="db-card-cate">{{ $dbFetch.item.category }}</div>
  </div>
</div>
{{ else }}
<p style="text-align: center">
  <small>Failed to fetch content, please check the API validity.</small>
</p>
{{ end }}
